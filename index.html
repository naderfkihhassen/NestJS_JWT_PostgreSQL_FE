<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Manager</title>
  <style>
    * { box-sizing: border-box; font-family: system-ui; }

    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(120deg, #6b73ff, #7e57c2);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .hidden { display: none !important; }

    .card {
      background: #fff;
      padding: 24px;
      width: 340px;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .tabs button {
      flex: 1;
      padding: 8px;
      border-radius: 10px;
      border: none;
      background: #eee;
      cursor: pointer;
    }

    .tabs .active {
      background: #6b73ff;
      color: white;
    }

    input, textarea, select, button {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 14px;
    }

    button {
      background: #6b73ff;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #5a62e6;
    }

    button.secondary {
      background: #95a5a6;
    }

    button.secondary:hover {
      background: #7f8c8d;
    }

    button.edit-btn {
      background: #f39c12;
    }

    button.edit-btn:hover {
      background: #e67e22;
    }

    button.share-btn {
      background: #16a085;
    }

    button.share-btn:hover {
      background: #138d75;
    }

    button.delete-btn {
      background: #e74c3c;
    }

    button.delete-btn:hover {
      background: #c0392b;
    }

    #app {
      width: 700px;
      max-width: 95vw;
      background: #f5f6fa;
      padding: 20px;
      border-radius: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    header > div {
      display: flex;
      gap: 8px;
    }

    header button {
      width: auto;
      padding: 8px 16px;
      margin: 0;
    }

    .task {
      background: white;
      padding: 18px;
      border-radius: 16px;
      margin-top: 12px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
    }

    .task h4 {
      margin: 0 0 8px 0;
      font-size: 18px;
    }

    .task p {
      margin: 0 0 12px 0;
      color: #666;
      font-size: 14px;
    }

    .task-meta {
      margin-bottom: 12px;
    }

    .task-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .task-actions button {
      width: auto;
      padding: 8px 14px;
      margin: 0;
      font-size: 13px;
      font-weight: 500;
    }

    .badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      margin-right: 6px;
      margin-bottom: 4px;
    }

    .badge.owner {
      background: #3498db;
      color: white;
    }

    .badge.shared {
      background: #e74c3c;
      color: white;
    }

    .badge.read {
      background: #95a5a6;
      color: white;
    }

    .badge.write {
      background: #27ae60;
      color: white;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-card {
      background: white;
      padding: 24px;
      border-radius: 16px;
      width: 380px;
      max-width: 90vw;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    .modal-card h3 {
      margin-top: 0;
      margin-bottom: 16px;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    .modal-actions button {
      flex: 1;
      margin: 0;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
      font-family: inherit;
    }

    .empty-state {
      text-align: center;
      color: #666;
      padding: 40px 20px;
      background: white;
      border-radius: 16px;
      margin-top: 12px;
    }
  </style>
</head>
<body>

<div id="auth-card" class="card">
  <h2>Task Manager</h2>

  <div class="tabs">
    <button id="loginTab" class="active">Login</button>
    <button id="registerTab">Register</button>
  </div>

  <div id="authForm">
    <input id="email" placeholder="Email" type="email" />
    <input id="password" type="password" placeholder="Password" />
    <button id="authBtn">Login</button>
  </div>

  <div id="verificationMessage" class="hidden" style="text-align: center; padding: 20px;">
    <p style="color: #27ae60; font-weight: 600;">‚úì Registration successful!</p>
    <p style="color: #666; font-size: 14px;">Please check your email to verify your account.</p>
    <button id="resendBtn" style="margin-top: 10px;">Resend Verification Email</button>
    <button id="backToLoginBtn" class="secondary" style="margin-top: 10px;">Back to Login</button>
  </div>
</div>

<!-- Verification Success Card -->
<div id="verify-card" class="card hidden">
  <div style="text-align: center;">
    <h2>‚úì Email Verified!</h2>
    <p style="color: #666;">Your email has been successfully verified. Redirecting to your tasks...</p>
  </div>
</div>

<div id="app" class="hidden">
  <header>
    <h2>My Tasks</h2>
    <div>
      <button id="newTaskBtn">+ New Task</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </header>

  <div id="tasks"></div>
</div>

<!-- Task Modal -->
<div id="taskModal" class="modal hidden">
  <div class="modal-card">
    <h3 id="taskModalTitle">New Task</h3>
    <input id="taskTitle" placeholder="Task title" />
    <textarea id="taskDesc" placeholder="Task description (optional)"></textarea>
    <div class="modal-actions">
      <button id="saveTaskBtn">Save</button>
      <button id="cancelTaskBtn" class="secondary">Cancel</button>
    </div>
  </div>
</div>

<!-- Share Modal -->
<div id="shareModal" class="modal hidden">
  <div class="modal-card">
    <h3>Share Task</h3>
    <p style="font-size: 14px; color: #666; margin-top: 0;">Share "<span id="shareTaskTitle"></span>" with another user</p>
    <input id="shareEmail" placeholder="Enter user's email" type="email" />
    <select id="sharePermission">
      <option value="READ">Read Only</option>
      <option value="WRITE">Can Edit</option>
    </select>
    <div class="modal-actions">
      <button id="confirmShareBtn">Share Task</button>
      <button id="cancelShareBtn" class="secondary">Cancel</button>
    </div>
  </div>
</div>

<script>
  // API URL configuration
  const API = (() => {
    const hostname = window.location.hostname;
    if (hostname === 'localhost' || hostname === '127.0.0.1') {
      return 'http://localhost:3000';
    }
    return 'https://nest-js-jwt-postgre-sql.vercel.app';
  })();

  let token = null;
  let editingTaskId = null;
  let sharingTaskId = null;
  let allTasks = [];
  let pendingVerificationEmail = null;

  console.log('Task Manager initialized');

  // Check for verification in URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const isVerified = urlParams.get('verified');
  const urlToken = urlParams.get('token');
  const verificationError = urlParams.get('error');
  
  if (isVerified === 'true' && urlToken) {
    // Email verified successfully
    token = urlToken;
    document.getElementById('auth-card').classList.add('hidden');
    document.getElementById('verify-card').classList.remove('hidden');
    
    // Clear URL parameters
    window.history.replaceState({}, document.title, window.location.pathname);
    
    // Show app after 2 seconds
    setTimeout(() => {
      document.getElementById('verify-card').classList.add('hidden');
      showApp();
    }, 2000);
  } else if (isVerified === 'false') {
    // Verification failed
    alert('Verification failed: ' + (verificationError || 'Unknown error'));
    window.history.replaceState({}, document.title, window.location.pathname);
  }

  // ---------- AUTH ----------
  const loginTab = document.getElementById('loginTab');
  const registerTab = document.getElementById('registerTab');
  const authBtn = document.getElementById('authBtn');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');

  loginTab.addEventListener('click', () => {
    loginTab.classList.add('active');
    registerTab.classList.remove('active');
    authBtn.textContent = 'Login';
  });

  registerTab.addEventListener('click', () => {
    registerTab.classList.add('active');
    loginTab.classList.remove('active');
    authBtn.textContent = 'Register';
  });

  authBtn.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;

    if (!email || !password) {
      alert('Please enter both email and password');
      return;
    }

    const endpoint = loginTab.classList.contains('active') ? 'login' : 'register';

    try {
      const res = await fetch(`${API}/auth/${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });

      const data = await res.json();

      if (!res.ok) {
        alert(data.message || 'Authentication failed');
        return;
      }

      if (endpoint === 'register') {
        // Show verification message
        pendingVerificationEmail = email;
        document.getElementById('authForm').classList.add('hidden');
        document.getElementById('verificationMessage').classList.remove('hidden');
      } else {
        // Login successful
        token = data.access_token;
        console.log('Logged in successfully');
        showApp();
      }
    } catch (err) {
      console.error('Auth error:', err);
      alert('Connection error. Make sure backend is running');
    }
  });

  // Resend verification email
  document.getElementById('resendBtn').addEventListener('click', async () => {
    if (!pendingVerificationEmail) return;
    
    try {
      const res = await fetch(`${API}/auth/resend-verification`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: pendingVerificationEmail })
      });

      const data = await res.json();
      
      if (res.ok) {
        alert('‚úì Verification email sent! Please check your inbox.');
      } else {
        alert(data.message || 'Failed to resend email');
      }
    } catch (err) {
      console.error('Resend error:', err);
      alert('Failed to resend verification email');
    }
  });

  // Back to login
  document.getElementById('backToLoginBtn').addEventListener('click', () => {
    document.getElementById('authForm').classList.remove('hidden');
    document.getElementById('verificationMessage').classList.add('hidden');
    loginTab.click();
    emailInput.value = '';
    passwordInput.value = '';
  });

  // Verify email token from URL
  async function verifyEmailToken(verificationToken) {
    document.getElementById('auth-card').classList.add('hidden');
    document.getElementById('verify-card').classList.remove('hidden');

    try {
      const res = await fetch(`${API}/auth/verify?token=${verificationToken}`);
      const data = await res.json();

      if (res.ok) {
        // Set the token from verification response
        token = data.access_token;
        console.log('Email verified, token received:', token);
        
        // Wait 2 seconds then show app
        setTimeout(() => {
          document.getElementById('verify-card').classList.add('hidden');
          showApp();
        }, 2000);
      } else {
        alert(data.message || 'Verification failed');
        document.getElementById('verify-card').classList.add('hidden');
        document.getElementById('auth-card').classList.remove('hidden');
      }
    } catch (err) {
      console.error('Verification error:', err);
      alert('Verification failed. Please try again.');
      document.getElementById('verify-card').classList.add('hidden');
      document.getElementById('auth-card').classList.remove('hidden');
    }
  }

  document.getElementById('logoutBtn').addEventListener('click', () => {
    token = null;
    allTasks = [];
    document.getElementById('auth-card').classList.remove('hidden');
    document.getElementById('app').classList.add('hidden');
    emailInput.value = '';
    passwordInput.value = '';
  });

  function showApp() {
    document.getElementById('auth-card').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    loadTasks();
  }

  // ---------- LOAD TASKS ----------
  async function loadTasks() {
    try {
      const res = await fetch(`${API}/tasks`, {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      });

      if (!res.ok) {
        throw new Error('Failed to load tasks');
      }

      const tasks = await res.json();
      allTasks = tasks;
      console.log('Loaded tasks:', tasks);
      renderTasks(tasks);
    } catch (err) {
      console.error('Load tasks error:', err);
      alert('Failed to load tasks: ' + err.message);
    }
  }

  function renderTasks(tasks) {
    const container = document.getElementById('tasks');
    container.innerHTML = '';

    if (!tasks || tasks.length === 0) {
      container.innerHTML = '<div class="empty-state">üìù No tasks yet. Create your first task to get started!</div>';
      return;
    }

    tasks.forEach(task => {
      const taskDiv = document.createElement('div');
      taskDiv.className = 'task';

      let html = `<h4>${escapeHtml(task.title)}</h4>`;
      html += `<p>${escapeHtml(task.description || 'No description provided')}</p>`;
      html += `<div class="task-meta">`;

      // Ownership badge
      if (task.isOwner === true) {
        html += `<span class="badge owner">‚úì Owner</span>`;
      } else {
        html += `<span class="badge shared">‚Üì Shared with you</span>`;
      }

      // Permission badge (only for shared tasks)
      if (task.permission) {
        const permLower = task.permission.toLowerCase();
        const permText = permLower === 'read' ? 'Read Only' : 'Can Edit';
        html += `<span class="badge ${permLower}">${permText}</span>`;
      }

      html += `</div>`;

      // Action buttons
      html += `<div class="task-actions">`;

      // Edit button - show if owner or has WRITE permission
      const canEdit = task.isOwner === true || task.permission === 'WRITE';
      if (canEdit) {
        html += `<button class="edit-btn" data-task-id="${task.id}" data-action="edit">‚úèÔ∏è Edit</button>`;
      }

      // Share button - only for owners
      if (task.isOwner === true) {
        html += `<button class="share-btn" data-task-id="${task.id}" data-task-title="${escapeHtml(task.title)}" data-action="share">üîó Share</button>`;
      }

      // Delete button - owner or WRITE permission
      if (canEdit) {
        html += `<button class="delete-btn" data-task-id="${task.id}" data-action="delete">üóëÔ∏è Delete</button>`;
      }

      html += `</div>`;

      taskDiv.innerHTML = html;
      container.appendChild(taskDiv);
    });

    // Attach event listeners to buttons
    document.querySelectorAll('[data-action="edit"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const taskId = parseInt(this.getAttribute('data-task-id'));
        handleEditTask(taskId);
      });
    });

    document.querySelectorAll('[data-action="share"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const taskId = parseInt(this.getAttribute('data-task-id'));
        const taskTitle = this.getAttribute('data-task-title');
        handleShareTask(taskId, taskTitle);
      });
    });

    document.querySelectorAll('[data-action="delete"]').forEach(btn => {
      btn.addEventListener('click', function() {
        const taskId = parseInt(this.getAttribute('data-task-id'));
        handleDeleteTask(taskId);
      });
    });
  }

  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ---------- CREATE TASK ----------
  document.getElementById('newTaskBtn').addEventListener('click', () => {
    editingTaskId = null;
    document.getElementById('taskModalTitle').textContent = 'Create New Task';
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDesc').value = '';
    document.getElementById('taskModal').classList.remove('hidden');
  });

  // ---------- SAVE TASK ----------
  document.getElementById('saveTaskBtn').addEventListener('click', async () => {
    const title = document.getElementById('taskTitle').value.trim();
    const description = document.getElementById('taskDesc').value.trim();

    if (!title) {
      alert('Please enter a task title');
      return;
    }

    const taskData = {
      title: title,
      description: description
    };

    try {
      let res;

      if (editingTaskId) {
        console.log('Updating task:', editingTaskId);
        res = await fetch(`${API}/tasks/${editingTaskId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(taskData)
        });
      } else {
        console.log('Creating new task');
        res = await fetch(`${API}/tasks`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(taskData)
        });
      }

      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.message || 'Failed to save task');
      }

      const result = await res.json();
      console.log('Task saved:', result);

      closeTaskModal();
      await loadTasks();
    } catch (err) {
      console.error('Save task error:', err);
      alert('Failed to save task: ' + err.message);
    }
  });

  document.getElementById('cancelTaskBtn').addEventListener('click', closeTaskModal);

  function closeTaskModal() {
    document.getElementById('taskModal').classList.add('hidden');
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDesc').value = '';
    editingTaskId = null;
  }

  // ---------- EDIT TASK ----------
  function handleEditTask(taskId) {
    console.log('Editing task:', taskId);
    editingTaskId = taskId;

    const task = allTasks.find(t => t.id === taskId);

    if (task) {
      document.getElementById('taskModalTitle').textContent = 'Edit Task';
      document.getElementById('taskTitle').value = task.title;
      document.getElementById('taskDesc').value = task.description || '';
      document.getElementById('taskModal').classList.remove('hidden');
    } else {
      alert('Task not found');
    }
  }

  // ---------- DELETE TASK ----------
  async function handleDeleteTask(taskId) {
    if (!confirm('Are you sure you want to delete this task?')) {
      return;
    }

    try {
      console.log('Deleting task:', taskId);
      const res = await fetch(`${API}/tasks/${taskId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.message || 'Failed to delete task');
      }

      console.log('Task deleted successfully');
      await loadTasks();
    } catch (err) {
      console.error('Delete task error:', err);
      alert('Failed to delete task: ' + err.message);
    }
  }

  // ---------- SHARE TASK ----------
  function handleShareTask(taskId, taskTitle) {
    console.log('Sharing task:', taskId);
    sharingTaskId = taskId;
    document.getElementById('shareTaskTitle').textContent = taskTitle;
    document.getElementById('shareEmail').value = '';
    document.getElementById('sharePermission').value = 'READ';
    document.getElementById('shareModal').classList.remove('hidden');
  }

  document.getElementById('confirmShareBtn').addEventListener('click', async () => {
    const email = document.getElementById('shareEmail').value.trim();
    const permission = document.getElementById('sharePermission').value;

    if (!email) {
      alert('Please enter an email address');
      return;
    }

    const shareData = {
      email: email,
      permission: permission
    };

    try {
      console.log('Sharing task:', sharingTaskId, 'with:', shareData);

      const res = await fetch(`${API}/tasks/${sharingTaskId}/share`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(shareData)
      });

      if (!res.ok) {
        const error = await res.json();
        throw new Error(error.message || 'Failed to share task');
      }

      const result = await res.json();
      console.log('Task shared successfully:', result);

      closeShareModal();
      alert(`‚úì Task shared successfully with ${email}!`);
      await loadTasks();
    } catch (err) {
      console.error('Share task error:', err);
      alert('Failed to share task: ' + err.message);
    }
  });

  document.getElementById('cancelShareBtn').addEventListener('click', closeShareModal);

  function closeShareModal() {
    document.getElementById('shareModal').classList.add('hidden');
    document.getElementById('shareEmail').value = '';
    sharingTaskId = null;
  }

  // Close modals on outside click
  document.getElementById('taskModal').addEventListener('click', (e) => {
    if (e.target.id === 'taskModal') closeTaskModal();
  });

  document.getElementById('shareModal').addEventListener('click', (e) => {
    if (e.target.id === 'shareModal') closeShareModal();
  });
</script>
</body>
</html>